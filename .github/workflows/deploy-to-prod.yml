name: Deploy to Prod and Push to Databricks

on:
  workflow_dispatch:
    inputs:
      confirmation:
        description: "Type 'yes' to confirm deployment to production"
        required: true
        default: "no"

jobs:
  deploy:
    if: github.ref == 'refs/heads/prod' && github.event.inputs.confirmation == 'yes'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout prod branch
        uses: actions/checkout@v3
        with:
          ref: prod  # Check out the prod branch

      - name: Configure Git User
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: Fetch all branches
        run: git fetch --all

      - name: Check out main branch
        run: git checkout main  # Check out the main branch

      - name: Merge main into prod
        run: |
          git checkout prod
          git merge main --allow-unrelated-histories -m "Manual deployment from main to prod"

      - name: Add Remote with PAT
        # Add a new remote that includes the PAT for authentication
        run: |
          git remote add github https://${{secrets.PERSONAL_ACCESS_TOKEN}}@github.com/arvindarrives25/dev_project.git

      - name: Push to prod branch
        # Push changes to prod branch using the configured remote
        run: |
          git push github prod

      # Deploy to Azure Databricks using Databricks CLI
      - name: Install Databricks CLI
        run: pip install databricks-cli

      - name: Configure Databricks CLI
        env:
          DATABRICKS_HOST: "https://adb-3549450377455778.18.azuredatabricks.net"  # Replace with your Databricks URL
          DATABRICKS_TOKEN: ${{secrets.DATABRICKS_TOKEN}}
        run: |
          databricks configure --token <<< "${DATABRICKS_HOST}\n${DATABRICKS_TOKEN}"

      - name: Upload Notebooks to Databricks
        run: |
          databricks workspace import_dir . "/Workspace/Repos/monika_kumar5@outlook.com/prod_project" --overwrite
